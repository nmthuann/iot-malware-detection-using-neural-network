import shutil
import os
import glob
import argparse
from numpy import random

#chọn dst cho dataset
dst_base =".\\dataset_1000"
dst_benign_1000 = dst_base +  "\\benign"
dst_malware_1000 = dst_base + "\\malware"
dst_test = ".\\test"

#thu thập tất cả các samples
benign_samples = glob.glob(".\\out\\benign\\*.png")
malware_samples = glob.glob(".\\out\\malware\\*.png")

def rem_all_file(path):
    files = glob.glob(path + "\\*")
    for file in files:
        os.remove(file)

def get_random_malware_sample(size=1000, replace = False):
    return random.choice(malware_samples, size, replace)

def get_random_benign_sample(size=1000, replace = False):
    return random.choice(benign_samples, size, replace)

def main():

    parser = argparse.ArgumentParser(description="Tools to generate dataset and tests sample")
    parser.add_argument('type', metavar='type', type=str, help='generation type | all: genrate dataset and test | test: test only | train: train dataset only')
    parser.add_argument('--size',dest='size', type=int, default=1000, help='size per class')

    args = parser.parse_args()
    if args.type == 'train' or args.type == 'all':
        if not os.path.exists(dst_base):
            print("[!] Dataset not initialize")
            os.makedirs(dst_base)

        if not os.path.exists(dst_benign_1000):
            os.makedirs(dst_benign_1000)
        else:
            print("[+] Cleaning up benign sample")
            rem_all_file(dst_benign_1000)

        if not os.path.exists(dst_malware_1000):
            os.makedirs(dst_malware_1000)
        else:
            print("[+] Cleaning up malware sample")
            rem_all_file(dst_malware_1000)

        #copy từ src => dst
        for i in get_random_benign_sample(args.size):
            shutil.copy(src=i, dst=dst_benign_1000)

        for i in get_random_malware_sample(args.size):
            shutil.copy(src=i, dst=dst_malware_1000)

    if args.type == 'test' or args.type == 'all':
        print("[+] Preparing test dataset")
        print("[+] Creating new test with size {} per class".format(args.size))
        if not os.path.exists(dst_test):
            os.makedirs(dst_test)
        else:
            shutil.rmtree(dst_test)

        os.makedirs(dst_test + "\\benign")
        os.makedirs(dst_test + "\\malware")

        for i in get_random_malware_sample(args.size):
            shutil.copy(src=i, dst=dst_test + "\\malware")

        for i in get_random_benign_sample(args.size):
            shutil.copy(src=i, dst=dst_test + "\\benign")

if __name__ == "__main__":
    main()