import os
import multiprocessing
import lib.binvis as bv
    
#mã độc được lấy từ link: https://github.com/ArditDulemata/Curated-Malware-Database
#mật khẩu của file giải nén là: infected

malware_samples = os.listdir('./sample/IoT/')
cwd = os.getcwd()
out_path = '.\\out\\'

def calc_sample_entropy(sample):
    print('[+] Calucating entropy for {}'.format(sample))
    #cái này hardcode nên nếu muốn thay đổi đường đẫn thì chỉ cần thay mới đường dẫn hoặc viết hàm tương tự
    bv.binvis(cwd + '\\sample\\IoT\\' + sample, output_path=out_path)
    return

def main():
    new_malware_samples = malware_samples.copy()
    #loại bỏ các sample đã được tính entropy
    for sample in new_malware_samples:
        if os.path.isfile(out_path + sample + '.png'):
            print("[!] Sample {} already calculated skipping".format(sample))
            new_malware_samples.remove(sample)

    #worker poll
    with multiprocessing.Pool(5) as p:
        p.map(calc_sample_entropy, new_malware_samples)

if __name__ == "__main__":
    main()